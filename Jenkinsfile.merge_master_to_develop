// Merge master to develop.
// If any merge conflicts, report to Slack.
// If success, push branch.

import org.jenkinsci.plugins.workflow.steps.FlowInterruptedException
import groovy.transform.Field

// Shared libraries, configured in https://ci.senseilabs.com/configure.
// Ref https://jenkins.io/doc/book/pipeline/shared-libraries/
@Library('genome') _
genome = new org.klick.Genome()
githelper = new org.klick.Git()

// Repo:
CODE_GITHUB_ORG = 'jeff-zohrab'  // TODO - fix this
CODE_REPO_NAME = 'klick-genome-CI-stub'  // TODO - fix this

// Slack channel to report to.
slack_channel = '#jenkins-dev-tests'

node('sensei_build') {

  genome.create_dir("c:\\www")
  ws("c:\\www\\genome") {

    try {
      checkout()
      fetch_latest_master()
      try_merge()
    }
    catch(FlowInterruptedException interruptEx) {
      currentBuild.result = 'ABORTED'
    }
    catch(err) {
      def msg = "Error: ${err}"
      echo msg
      report_failure(msg)
      currentBuild.result = 'FAILURE'
    }
    finally {
      cleanWs()
    }

  } // end ws()

}  // end node


///////////////////////////////////////////////////
// Helpers


def checkout() {
  stage('Checkout') {
    genome.stop_iis()  // Must use a shared lib, local repo isn't checked out yet.
    cleanWs()
    checkout_args = [
      workspace_dir: env.WORKSPACE,
      branch_name: 'develop',
      github_org: CODE_GITHUB_ORG,
      repo_name: CODE_REPO_NAME,
      ref_repo_parent_dir: 'c:\\reference_repo',
      creds_id: 'github-ci'
    ]
    githelper.checkout_from_reference_repo(checkout_args)
  }
}


// Some commands may fail, which is annoying but shouldn't be fatal.
def bat_no_fail(command) {
  try {
    bat command
  }
  catch(err) {
    echo "SWALLOW EXCEPTION FOR COMMAND: ${command}"
  }
}


def with_upstream_context(args, commands) {
  bat_no_fail("git remote remove upstream")
  withCredentials([usernamePassword(credentialsId: args.creds_id, passwordVariable: 'P', usernameVariable: 'U')]) {
    bat "git remote add upstream https://${U}:${P}@github.com/${args.github_org}/${args.repo_name}.git"
  } // end with
  try {
    commands()
  }
  finally {
    bat_no_fail("git remote remove upstream")
  }
}


def fetch_latest_master() {
  stage('Fetch master') {
    args = [
      creds_id: 'github-ci',
      github_org: CODE_GITHUB_ORG,
      repo_name: CODE_REPO_NAME
    ]
    with_upstream_context(args) {
      def cmd = "git fetch --depth=10 --no-tags upstream ${branch_name}:refs/remotes/upstream/${branch_name}"
      echo "Running: ${cmd}"
      bat cmd
    }
  }
}

def try_merge() {
  stage('Merge') {
    set_user()
    merge()
    if(have_conflicts()) {
      report_failure(build_merge_failure_message())
      currentBuild.result = 'FAILURE'
    }
    else {
      push_merged_branch()
      currentBuild.result = 'SUCCESS'
    }
  }
}

// User required to sign the merge commit.
def set_user() {
  bat "git config --global user.email \"jzohrab@gmail.com\""  // TODO fix
  bat "git config --global user.name \"Jeff Zohrab\""  // TODO fix
}

def merge() {
  echo "todo"
}


def push_merged_branch() {
  echo "todo"
}


def files_with_conflicts() {
  // return []
  return ['a.txt', 'b.txt', 'c.txt', 'd.txt'] // , 'e.txt', 'f.txt']
}

def have_conflicts() {
  echo "XXXXXXXXXXXXX checking conflicts:"  // TODO remove
  echo "Files: ${files_with_conflicts()}"
  return (files_with_conflicts().size() > 0)
}

// =============================
// Report failure

def build_merge_failure_message() {
  def show_count = 5
  def files = files_with_conflicts()
  def top_files = files.take(show_count)
  report_top_files = top_files.collect { s -> " * ${s}" }
  def addendum = ''
  if (files.size() > show_count) {
    addendum = "_... and ${files.size() - show_count} more_"
  }

  return """*Merge of master into develop failed.*

Conflicts:
${report_top_files.join('\n')}
${addendum}

Please create a new feature off of develop,
and merge master into it, resolving the conflicts
as usual.

${env.Job_URL} (number ${currentBuild.number})"""
} // 


def report_failure(msg) {
  slackSend channel: slack_channel,
    color: '#ff0000',
    message: msg,
    teamDomain: 'senseilabs',
    tokenCredentialId: 'senseilabs-slack-token'
}
